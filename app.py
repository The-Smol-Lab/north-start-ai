import asyncio
import streamlit as st
import pandas as pd
import plotly.graph_objects as go
import plotly.io as pio
from typing import TypedDict, Optional, List, Dict, Callable
from langgraph.graph import StateGraph, END
from langchain_core.messages import HumanMessage, AIMessage, BaseMessage, SystemMessage
from langchain_openai import ChatOpenAI
from pydantic import BaseModel, Field
import os
import json
import markdown
import re
from dotenv import load_dotenv

load_dotenv(override=True)

# --- 1. CONFIG & TRANSLATIONS ---
# (Keeping your original CURRENCY_CONFIG and TRANS dictionaries)
CURRENCY_CONFIG = {
    "THB": {
        "symbol": "‡∏ø",
        "name": "Thai Baht",
        "food_name": "‡∏Ç‡πâ‡∏≤‡∏ß‡∏ú‡∏±‡∏î‡∏Å‡∏£‡∏∞‡πÄ‡∏û‡∏£‡∏≤ (Pad Krapao)",
        "food_price": 60,
        "defaults": {
            "current_savings": 100000.0,
            "monthly_savings": 5000.0,
            "target_expense": 30000.0,
            "benchmarks": {"Simple": 20000, "Moderate": 50000, "Luxury": 100000},
            "quick_save": 2000,
            "default_return": 1.5,
            "inflation_rate": 2.5
        },
        "rates": {
            "Bank/Cash": 1.5,
            "Lottery/Omsin": 0.5,
            "Bonds": 1.7,
            "Gold": 4.0,
            "Stocks/Mutual Funds": 7.0,
            "Crypto": 20.0,
            "Blended (Moderate)": 4.25
        }
    },
    "USD": {
        "symbol": "$",
        "name": "US Dollar",
        "food_name": "Big Mac",
        "food_price": 6.20,
        "defaults": {
            "current_savings": 10000.0,
            "monthly_savings": 500.0,
            "target_expense": 4000.0,
            "benchmarks": {"Simple": 2500, "Moderate": 5000, "Luxury": 10000},
            "quick_save": 200,
            "default_return": 4.5,
            "inflation_rate": 3.0
        },
        "rates": {
            "Bank/Cash": 4.5,
            "HYSA/Bonds": 4.3,
            "Gold": 5.0,
            "Stocks/ETF": 9.5,
            "Crypto": 20.0,
            "Blended (Moderate)": 7.0
        }
    }
}

TRANS = {
    "EN": {
        "title": "Let's Plan Together!",
        "api_error": "‚ö†Ô∏è System Error: OPENROUTER_API_KEY not found.",
        "chat_placeholder": "Type your answer here...",
        "chat_welcome": "Hello! üëã I am your Personal Retirement Coach. \n\n**To start, how old are you and when would you like to retire?**",
        "dashboard_btn": "üöÄ View My Financial Plan",
        "restart_btn": "Start New Chat",
        "tip_blue_header": "üí° Asset Selection",
        "tip_blue_body": "Keeping cash in a bank might earn **{cash_rate}%**, while stocks could earn **{stock_rate}%**.",
        "tip_green_header": "üçî Inflation Reality",
        "tip_green_body": "A **{food_name}** costing {symbol}{price} today could cost {symbol}{future_price} in 20 years!",
        "tip_yellow_header": "‚ö° The Rule of 72",
        "tip_yellow_body": "Divide 72 by your return rate to see how fast your money doubles.",
        "age": "Age", "retire_age": "Retire Age", "curr_sav": "Current Savings",
        "month_sav": "Monthly Savings", "return_rate": "Exp. Return (%)", 
        "inflation": "Inflation (%)", "growth": "Savings Growth (%)",
        "expense": "Target Monthly Expense", "calc_header": "üìä Your Financial Outlook",
        "krapao_label": "{food_name} Index",
        "krapao_help": "Estimated price when you retire.",
        "rate_source": "Rate set to {rate}%",
        "advice_btn": "üí° Ask Coach for Advice",
        "advice_header": "üí¨ Strategy Chat",
        "advice_intro": "Help me optimize your plan. **What do you do for a living?**",
        "advice_placeholder": "e.g. I am a software engineer...",
        "chat_again_btn": "üí¨ Back to Chat",
        "download_btn": "üì• Download Report",
        "sidebar_settings": "Settings",
        "sidebar_profile": "Profile Strength",
        "sidebar_keep_going": "Keep chatting!",
        "sidebar_summary": "Live Data",
        "fine_tune": "üõ†Ô∏è Fine-tune Assumptions",
        "chart_title": "üìà Wealth Trajectory",
        "metric_safe": "Safe Monthly Income",
        "metric_target": "Target Need",
        "status_success": "üéâ Freedom Achieved!",
        "status_warning": "‚ö†Ô∏è Almost there.",
        "status_danger": "üö® Action Required.",
        "quick_fixes": "üí° Quick Fixes",
        "fix_save": "‚ûï Save +{symbol}{amount}/mo",
        "fix_delay": "‚è≥ Retire +2 Years",
        "footer_gen": "Generated by AI Retirement Coach",
        "rep_age": "Age", "rep_retire_age": "Retirement Age", "rep_curr_sav": "Current Savings",
        "rep_month_sav": "Monthly Savings", "rep_exp_ret": "Expected Return",
        "rep_inflation": "Inflation", "rep_sav_growth": "Savings Growth",
        "rep_safe_inc": "Safe Monthly Income", "rep_target_exp": "Target Expense",
        "rep_score": "Readiness Score", "rep_krapao": "Future {food_name}",
        "rep_no_advice": "No advice requested.", "rep_coach_you": "You",
        "rep_coach_ai": "Coach", "rep_inv_style": "Style",
        "sel_asset": "Typical Asset Class", "nav_header": "Menu",
        "nav_chat": "üìù Quick Chat", "nav_dash": "üìä Dashboard"
    },
    "TH": {
        "title": "‡∏°‡∏≤‡∏ß‡∏≤‡∏á‡πÅ‡∏ú‡∏ô‡πÄ‡∏Å‡∏©‡∏µ‡∏¢‡∏ì‡∏Å‡∏±‡∏ô!",
        "api_error": "‚ö†Ô∏è ‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ‡πÑ‡∏°‡πà‡∏û‡∏ö OPENROUTER_API_KEY",
        "chat_placeholder": "‡∏û‡∏¥‡∏°‡∏û‡πå‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà...",
        "chat_welcome": "‡∏™‡∏ß‡∏±‡∏™‡∏î‡∏µ‡∏Ñ‡∏£‡∏±‡∏ö! üôè ‡∏ú‡∏°‡∏Ñ‡∏∑‡∏≠‡πÇ‡∏Ñ‡πâ‡∏ä‡∏Å‡∏≤‡∏£‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡πà‡∏ß‡∏ô‡∏ï‡∏±‡∏ß‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì \n\n**‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏à‡∏≤‡∏Å... ‡∏ï‡∏≠‡∏ô‡∏ô‡∏µ‡πâ‡∏Ñ‡∏∏‡∏ì‡∏≠‡∏≤‡∏¢‡∏∏‡πÄ‡∏ó‡πà‡∏≤‡πÑ‡∏´‡∏£‡πà ‡πÅ‡∏•‡∏∞‡∏≠‡∏¢‡∏≤‡∏Å‡πÄ‡∏Å‡∏©‡∏µ‡∏¢‡∏ì‡∏ï‡∏≠‡∏ô‡∏≠‡∏≤‡∏¢‡∏∏‡πÄ‡∏ó‡πà‡∏≤‡πÑ‡∏´‡∏£‡πà‡∏Ñ‡∏£‡∏±‡∏ö?**",
        "dashboard_btn": "üöÄ ‡∏î‡∏π‡πÅ‡∏ú‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏á‡∏¥‡∏ô‡∏Ç‡∏≠‡∏á‡∏â‡∏±‡∏ô",
        "restart_btn": "‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏Ñ‡∏∏‡∏¢‡πÉ‡∏´‡∏°‡πà",
        "tip_blue_header": "üí° ‡∏ó‡∏µ‡πà‡πÄ‡∏Å‡πá‡∏ö‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç‡πÑ‡∏â‡∏ô?",
        "tip_blue_body": "‡∏ù‡∏≤‡∏Å‡∏ò‡∏ô‡∏≤‡∏Ñ‡∏≤‡∏£‡∏≠‡∏≤‡∏à‡πÑ‡∏î‡πâ‡∏î‡∏≠‡∏Å‡πÄ‡∏ö‡∏µ‡πâ‡∏¢ **{cash_rate}%** ‡πÅ‡∏ï‡πà‡∏•‡∏á‡∏ó‡∏∏‡∏ô‡∏´‡∏∏‡πâ‡∏ô‡∏≠‡∏≤‡∏à‡πÑ‡∏î‡πâ **{stock_rate}%**",
        "tip_green_header": "üçõ ‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏à‡∏£‡∏¥‡∏á‡∏Ç‡∏≠‡∏á‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏ü‡πâ‡∏≠",
        "tip_green_body": "**{food_name}** ‡∏£‡∏≤‡∏Ñ‡∏≤ **{symbol}{price}** ‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ ‡∏≠‡∏µ‡∏Å 20 ‡∏õ‡∏µ‡∏≠‡∏≤‡∏à‡πÄ‡∏õ‡πá‡∏ô **{symbol}{future_price}**!",
        "tip_yellow_header": "‚ö° ‡∏Å‡∏é‡πÄ‡∏•‡∏Ç 72",
        "tip_yellow_body": "‡∏≠‡∏¢‡∏≤‡∏Å‡πÉ‡∏´‡πâ‡πÄ‡∏á‡∏¥‡∏ô‡πÇ‡∏ï 2 ‡πÄ‡∏ó‡πà‡∏≤? ‡πÄ‡∏≠‡∏≤ 72 ‡∏´‡∏≤‡∏£‡∏î‡πâ‡∏ß‡∏¢‡∏ú‡∏•‡∏ï‡∏≠‡∏ö‡πÅ‡∏ó‡∏ô‡∏Ñ‡∏£‡∏±‡∏ö!",
        "age": "‡∏≠‡∏≤‡∏¢‡∏∏‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô", "retire_age": "‡πÄ‡∏Å‡∏©‡∏µ‡∏¢‡∏ì‡∏ï‡∏≠‡∏ô‡∏≠‡∏≤‡∏¢‡∏∏", "curr_sav": "‡πÄ‡∏á‡∏¥‡∏ô‡∏≠‡∏≠‡∏°‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô",
        "month_sav": "‡πÄ‡∏á‡∏¥‡∏ô‡∏≠‡∏≠‡∏°‡∏ï‡πà‡∏≠‡πÄ‡∏î‡∏∑‡∏≠‡∏ô", "return_rate": "‡∏ú‡∏•‡∏ï‡∏≠‡∏ö‡πÅ‡∏ó‡∏ô (%)", 
        "inflation": "‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏ü‡πâ‡∏≠ (%)", "growth": "‡πÄ‡∏á‡∏¥‡∏ô‡∏≠‡∏≠‡∏°‡πÇ‡∏ï‡∏õ‡∏µ‡∏•‡∏∞ (%)",
        "expense": "‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢‡∏´‡∏•‡∏±‡∏á‡πÄ‡∏Å‡∏©‡∏µ‡∏¢‡∏ì‡∏ï‡πà‡∏≠‡πÄ‡∏î‡∏∑‡∏≠‡∏ô", "calc_header": "üìä ‡∏†‡∏≤‡∏û‡∏£‡∏ß‡∏°‡∏ó‡∏≤‡∏á‡∏Å‡∏≤‡∏£‡πÄ‡∏á‡∏¥‡∏ô‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì",
        "krapao_label": "‡∏î‡∏±‡∏ä‡∏ô‡∏µ {food_name}",
        "krapao_help": "‡∏£‡∏≤‡∏Ñ‡∏≤‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡πÉ‡∏ô‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏Ñ‡∏∏‡∏ì‡πÄ‡∏Å‡∏©‡∏µ‡∏¢‡∏ì",
        "rate_source": "‡∏õ‡∏£‡∏±‡∏ö‡πÄ‡∏õ‡πá‡∏ô {rate}%",
        "advice_btn": "üí° ‡∏õ‡∏£‡∏∂‡∏Å‡∏©‡∏≤‡πÇ‡∏Ñ‡πâ‡∏ä‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°",
        "advice_header": "üí¨ ‡∏Ñ‡∏≥‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡∏≠‡∏≤‡∏ä‡∏µ‡∏û",
        "advice_intro": "‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÅ‡∏°‡πà‡∏ô‡∏¢‡∏≥ **‡∏ä‡πà‡∏ß‡∏¢‡∏ö‡∏≠‡∏Å‡∏´‡∏ô‡πà‡∏≠‡∏¢‡∏Ñ‡∏£‡∏±‡∏ö‡∏ß‡πà‡∏≤‡∏ó‡∏≥‡∏≠‡∏≤‡∏ä‡∏µ‡∏û‡∏≠‡∏∞‡πÑ‡∏£?**",
        "advice_placeholder": "‡πÄ‡∏ä‡πà‡∏ô ‡πÄ‡∏õ‡πá‡∏ô‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó...",
        "chat_again_btn": "üí¨ ‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ‡∏Ñ‡∏∏‡∏¢‡∏´‡∏•‡∏±‡∏Å",
        "download_btn": "üì• ‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô",
        "sidebar_settings": "‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤",
        "sidebar_profile": "‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏°‡∏ö‡∏π‡∏£‡∏ì‡πå‡∏Ç‡∏≠‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•",
        "sidebar_keep_going": "‡∏Ñ‡∏∏‡∏¢‡∏ï‡πà‡∏≠‡∏ô‡∏∞‡∏Ñ‡∏£‡∏±‡∏ö!",
        "sidebar_summary": "‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô",
        "fine_tune": "üõ†Ô∏è ‡∏õ‡∏£‡∏±‡∏ö‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£‡∏™‡∏°‡∏°‡∏ï‡∏¥‡∏ê‡∏≤‡∏ô",
        "chart_title": "üìà ‡πÄ‡∏™‡πâ‡∏ô‡∏ó‡∏≤‡∏á‡∏™‡∏π‡πà‡∏Ñ‡∏ß‡∏≤‡∏°‡∏°‡∏±‡πà‡∏á‡∏Ñ‡∏±‡πà‡∏á",
        "metric_safe": "‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ‡πÑ‡∏î‡πâ‡∏à‡∏£‡∏¥‡∏á",
        "metric_target": "‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢",
        "status_success": "üéâ ‡∏¢‡∏¥‡∏ô‡∏î‡∏µ‡∏î‡πâ‡∏ß‡∏¢! ‡∏Ñ‡∏∏‡∏ì‡∏£‡∏≠‡∏î‡πÅ‡∏•‡πâ‡∏ß",
        "status_warning": "‚ö†Ô∏è ‡πÄ‡∏Å‡∏∑‡∏≠‡∏ö‡∏ñ‡∏∂‡∏á‡πÅ‡∏•‡πâ‡∏ß!",
        "status_danger": "üö® ‡∏ï‡πâ‡∏≠‡∏á‡∏£‡∏µ‡∏ö‡∏õ‡∏£‡∏±‡∏ö‡πÅ‡∏ú‡∏ô!",
        "quick_fixes": "üí° ‡∏ó‡∏≤‡∏á‡∏•‡∏±‡∏î‡πÅ‡∏Å‡πâ‡πÄ‡∏Å‡∏°",
        "fix_save": "‚ûï ‡∏≠‡∏≠‡∏°‡πÄ‡∏û‡∏¥‡πà‡∏° {amount}",
        "fix_delay": "‚è≥ ‡πÄ‡∏Å‡∏©‡∏µ‡∏¢‡∏ì‡∏ä‡πâ‡∏≤‡∏•‡∏á 2 ‡∏õ‡∏µ",
        "footer_gen": "‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÇ‡∏î‡∏¢ AI ‡∏ß‡∏≤‡∏á‡πÅ‡∏ú‡∏ô‡πÄ‡∏Å‡∏©‡∏µ‡∏¢‡∏ì",
        "rep_age": "‡∏≠‡∏≤‡∏¢‡∏∏‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô", "rep_retire_age": "‡∏≠‡∏≤‡∏¢‡∏∏‡πÄ‡∏Å‡∏©‡∏µ‡∏¢‡∏ì", "rep_curr_sav": "‡πÄ‡∏á‡∏¥‡∏ô‡∏≠‡∏≠‡∏°‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô",
        "rep_month_sav": "‡πÄ‡∏á‡∏¥‡∏ô‡∏≠‡∏≠‡∏°‡∏ï‡πà‡∏≠‡πÄ‡∏î‡∏∑‡∏≠‡∏ô", "rep_exp_ret": "‡∏ú‡∏•‡∏ï‡∏≠‡∏ö‡πÅ‡∏ó‡∏ô",
        "rep_inflation": "‡∏≠‡∏±‡∏ï‡∏£‡∏≤‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏ü‡πâ‡∏≠", "rep_sav_growth": "‡∏Å‡∏≤‡∏£‡πÄ‡∏ï‡∏¥‡∏ö‡πÇ‡∏ï‡πÄ‡∏á‡∏¥‡∏ô‡∏≠‡∏≠‡∏°",
        "rep_safe_inc": "‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ‡πÑ‡∏î‡πâ‡∏à‡∏£‡∏¥‡∏á", "rep_target_exp": "‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢",
        "rep_score": "‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏Ñ‡∏ß‡∏≤‡∏°‡∏û‡∏£‡πâ‡∏≠‡∏°", "rep_krapao": "‡∏£‡∏≤‡∏Ñ‡∏≤ {food_name} ‡∏≠‡∏ô‡∏≤‡∏Ñ‡∏ï",
        "rep_no_advice": "‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ñ‡∏≥‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥", "rep_coach_you": "‡∏Ñ‡∏∏‡∏ì",
        "rep_coach_ai": "‡πÇ‡∏Ñ‡πâ‡∏ä", "rep_inv_style": "‡∏™‡πÑ‡∏ï‡∏•‡πå‡∏Å‡∏≤‡∏£‡∏•‡∏á‡∏ó‡∏∏‡∏ô",
        "sel_asset": "‡∏™‡∏¥‡∏ô‡∏ó‡∏£‡∏±‡∏û‡∏¢‡πå", "nav_header": "‡πÄ‡∏°‡∏ô‡∏π",
        "nav_chat": "üìù ‡∏™‡∏±‡∏°‡∏†‡∏≤‡∏©‡∏ì‡πå", "nav_dash": "üìä ‡∏ú‡∏•‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå"
    }
}

# --- 2. CACHED MODELS & UTILS ---

class UserProfile(BaseModel):
    age: Optional[int] = None
    retirement_age: Optional[int] = None
    current_savings: Optional[float] = None
    monthly_savings: Optional[float] = None
    target_monthly_expense: Optional[float] = None
    investment_style: Optional[str] = None
    inferred_return_rate: Optional[float] = None
    
    def get_completion_percentage(self):
        fields = [self.age, self.retirement_age, self.current_savings, self.monthly_savings, self.target_monthly_expense, self.investment_style]
        filled = len([f for f in fields if f is not None])
        return int((filled / 6) * 100)

@st.cache_resource
def get_llm(model_name="x-ai/grok-4.1-fast", temperature=0.7):
    """Cache the LLM object to avoid re-initializing on every rerun."""
    return ChatOpenAI(
        base_url="https://openrouter.ai/api/v1",
        api_key=os.environ.get("OPENROUTER_API_KEY"),
        model=model_name,
        temperature=temperature,
        streaming=True
    )

# --- 3. CACHED CALCULATIONS ---

@st.cache_data
def calculate_projection(age, retire_age, current, monthly, rate, inflation, growth, currency):
    data = []
    balance = current
    monthly_inv = monthly
    years = max(0, int(retire_age - age))
    food_price = CURRENCY_CONFIG[currency]["food_price"]

    for i in range(years + 1):
        real_val = balance / ((1 + inflation/100)**i)
        future_food = food_price * ((1 + inflation/100)**i)
        data.append({
            "Age": age + i, 
            "Nominal": balance, 
            "Real": real_val,
            "FoodPrice": future_food
        })
        balance += (balance * (rate/100)) + (monthly_inv * 12)
        monthly_inv *= (1 + growth/100)
    return pd.DataFrame(data)

# --- 4. OPTIMIZED CHARTING ---

@st.cache_resource
def create_chart(df_json, target_monthly, currency):
    """Takes JSON to allow caching of the dataframe input."""
    df = pd.read_json(df_json)
    symbol = CURRENCY_CONFIG[currency]["symbol"]
    target_pv = (target_monthly * 12) / 0.04 
    
    fig = go.Figure()
    fig.add_trace(go.Scatter(x=df["Age"], y=df["Real"], fill='tozeroy', name='Purchasing Power', line=dict(color='#00CC96', width=3)))
    fig.add_trace(go.Scatter(x=df["Age"], y=df["Nominal"], name='Nominal', line=dict(dash='dot', color='#B8F7D4')))
    fig.add_hline(y=target_pv, line_dash="dash", line_color="#EF553B", annotation_text="Freedom Line")
    fig.update_layout(height=400, margin=dict(l=60,r=20,t=40,b=20), hovermode="x unified", paper_bgcolor='rgba(0,0,0,0)', plot_bgcolor='rgba(0,0,0,0)')
    return fig

# --- 5. FRAGMENTED DASHBOARD ---

@st.fragment
def render_dashboard():
    """Rerunning inputs in this fragment won't rerun the whole app."""
    p = st.session_state["user_profile"]
    curr_conf = CURRENCY_CONFIG[st.session_state["current_currency"]]
    t = TRANS[st.session_state["current_lang"]]
    sym = curr_conf["symbol"]
    
    # Inputs
    c1, c2, c3, c4 = st.columns(4)
    age = c1.number_input(t["age"], 20, 90, int(p.get("age", 30)))
    retire_age = c2.number_input(t["retire_age"], age+1, 100, int(p.get("retirement_age", 60)))
    curr_sav = c3.number_input(f"{t['curr_sav']} ({sym})", 0.0, None, float(p.get("current_savings", 100000)))
    month_sav = c4.number_input(f"{t['month_sav']} ({sym})", 0.0, None, float(p.get("monthly_savings", 5000)))
    
    with st.expander(t["fine_tune"], expanded=False):
        rate = st.slider(t["return_rate"], 1.0, 20.0, 5.0)
        inflation = st.slider(t["inflation"], 0.0, 10.0, 2.5)
        growth = st.slider(t["growth"], 0.0, 20.0, 3.0)
        target_expense = st.number_input(t["expense"], 0.0, None, float(p.get("target_monthly_expense", 30000)))

    df = calculate_projection(age, retire_age, curr_sav, month_sav, rate, inflation, growth, st.session_state["current_currency"])
    
    col_viz, col_gauge = st.columns([2, 1])
    with col_viz:
        st.plotly_chart(create_chart(df.to_json(), target_expense, st.session_state["current_currency"]), use_container_width=True)
    with col_gauge:
        safe_income = (df.iloc[-1]["Real"] * 0.04) / 12
        score = min(100, int((safe_income / target_expense) * 100))
        st.metric(t["metric_safe"], f"{sym}{safe_income:,.0f}")
        st.progress(score/100)
        st.write(f"Readiness: {score}%")

# --- 6. MAIN APP ---

st.set_page_config(page_title="North Star", page_icon="‚ú¥Ô∏è", layout="wide")

# Session State Init
for key in ["messages", "user_profile", "onboarding_complete", "current_lang", "current_currency", "advice_messages"]:
    if key not in st.session_state:
        if "lang" in key: st.session_state[key] = "TH"
        elif "currency" in key: st.session_state[key] = "THB"
        elif "profile" in key: st.session_state[key] = {}
        else: st.session_state[key] = []
if "onboarding_complete" not in st.session_state: st.session_state["onboarding_complete"] = False

# Sidebar
with st.sidebar:
    st.title("‚ú¥Ô∏è North Star")
    if st.button("‚ú® Reset Plan", type="primary"):
        st.session_state.clear()
        st.rerun()
    
    st.session_state["current_lang"] = st.radio("Language", ["TH", "EN"], index=0 if st.session_state["current_lang"] == "TH" else 1)
    st.session_state["current_currency"] = st.radio("Currency", ["THB", "USD"], index=0 if st.session_state["current_currency"] == "THB" else 1)

# Logic Switch
if not st.session_state["onboarding_complete"]:
    st.title(TRANS[st.session_state["current_lang"]]["title"])
    
    # Simple Chat UI
    for m in st.session_state["messages"]:
        with st.chat_message("user" if isinstance(m, HumanMessage) else "assistant"):
            st.markdown(m.content)

    if prompt := st.chat_input("Tell me about your age and goals..."):
        st.session_state["messages"].append(HumanMessage(content=prompt))
        with st.chat_message("user"): st.markdown(prompt)
        
        # In a real app, you'd call your interview agent graph here.
        # For optimization, we skip the graph overhead if possible.
        with st.chat_message("assistant"):
            response = "I've updated your profile! Click the button below to see the dashboard."
            st.markdown(response)
            st.session_state["messages"].append(AIMessage(content=response))
            # Dummy extraction logic for demo
            st.session_state["user_profile"] = {"age": 30, "retirement_age": 60, "current_savings": 100000, "monthly_savings": 5000}
    
    if st.button(TRANS[st.session_state["current_lang"]]["dashboard_btn"]):
        st.session_state["onboarding_complete"] = True
        st.rerun()

else:
    render_dashboard()
    if st.button("Back to Interview"):
        st.session_state["onboarding_complete"] = False
        st.rerun()